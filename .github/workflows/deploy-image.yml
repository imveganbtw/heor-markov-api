# this workflow builds and deploys a container to azure

name: deploy

on: 
  workflow_run:
    workflows: ["ci"]
    branches: [main]
    types: 
      - completed

jobs:
  deploy:
    environment:
      name: CI
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Commit Hash
      uses: pr-mpt/actions-commit-hash@v1
    - run: docker build . -t heorvcc.azurecr.io/heor-markov-api:$GITHUB_SHA
    - uses: Azure/docker-login@v1
      with:
        username: ${{secrets.CONTAINER_REGISTRY_USERNAME}}
        password: ${{secrets.CONTAINER_REGISTRY_PASSWORD}}
        login-server: ${{secrets.CONTAINER_REGISTRY_LOGIN_URL}}
    - run: docker push heorvcc.azurecr.io/heor-markov-api:$GITHUB_SHA